= Canary
include::_attributes.adoc[]

[#canary-overview]
== Canary Overview

link:https://argo-rollouts.readthedocs.io/en/stable/features/canary/[Canary, window='_blank'] can be thought of as an advanced version of blue-green where instead of an abrupt cut-over
of live traffic between a current and new revision instead traffic is gradually increased to the new
version in increments, or steps. Like the proverbial link:https://en.wiktionary.org/wiki/canary_in_a_coal_mine[canary in the coal mine,window="_blank"],
the intent is to allow users to access the new version over time and if unexpected problems occur revert back to the
previous version.

This process is depicted in the diagram below where we see how we slowly migrate traffic from
the current version to the new version until the process is completed.

[NOTE]
Argo Rollouts does not currently have support for traffic shaping for OpenShift Routes. This
work is in progress and will be available in the future as Rollouts moves to GA status
in OpenShift GitOps.

image::overview-canary.png[]

To manage the transition of traffic between stable and canary services, Argo Rollouts supports a variety
of link:https://argo-rollouts.readthedocs.io/en/stable/features/traffic-management/[traffic management, window='_blank'] solutions. In
the absence of a traffic management solution, Rollouts will manage traffic weight on a best effort basis by adjusting
the number of pod replicas associated with each service.

[#deploy-canary-rollout]
== Deploy Canary Rollout

Now we will deploy the canary rollout in the `user%USERNUM%-prod` namespace following the same process that we did for the
blue-green in the previous modules. Prior to starting, confirm you are still at the correct path.

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
cd ~/argo-rollouts-workshop/documentation/modules/ROOT/examples/
----

Next, let's explore the manifests that we will be deploying in the `./canary/base` folder:

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
ls ./canary/base
----

Similar to previous modules, note we have files for `rollout.yaml`, `services.yaml` and `routes.yaml` which represent our Rollout, Services and Routes.

.link:https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary/base/rollout.yaml[./canary/base/rollout.yaml,window='_blank']
[source,yaml,subs="+macros,attributes+"]
----
include::ROOT:example$canary/base/rollout.yaml[]
----

In the canary strategy, like the blue-green strategy, we specify the services to use for stable and canary. However
unlike blue-green we specify a series of steps determining the flow of traffic between services. At each step we
can set the traffic weight, pause or perform an inline analysis.

For this example, the first step sets the weight to 20% and then pauses indefinitely since no duration
is specified. This will allow us to observe the behavior of the canary and validate that it is
performing as expected before performing a manual promotion.

Once the manual promotion has been performed, the remaining steps will continue to increase the
traffic weight with short pauses between each step. For the pause step the duration can be
specified in seconds, minutes or hours increments.

[NOTE]
For the purposes of this workshop the pause sequences are deliberately short, it is common
to have much longer pauses for more complex applications.

Next let's look at the Kubernetes services that are defined:

.link:https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary/base/services.yaml[./canary/base/services.yaml,window='_blank']
[source,yaml,subs="+macros,attributes+"]
----
include::ROOT:example$canary/base/services.yaml[]
----

As expected we have services for stable and canary defined however there is a new service called
all. This service is not managed by the rollout and includes all pods, we will use this service
to observe the behavior of the rollout.

[Important]
As mentioned previously, Argo Rollouts does not currently have support for traffic shaping for
OpenShift Routes. As a result we will be relying on the best effort approach of scaling pods.
The `all` service will enable us to see this by including all pods.

With the services out of the way now examine the routes:

.link:https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary/base/routes.yaml[./canary/base/routes.yaml,window='_blank']
[source,yaml,subs="+macros,attributes+"]
----
include::ROOT:example$canary/base/routes.yaml[]
----

We have defined a route to match each service that we saw previously. Note for the `all` route,
OpenShift Route annotations are being used to disable sticky sessions and use round-robin
load balancing. This enables us to observe the split of traffic as Rollouts manage the pod
replicas between stable and canary services.

To deploy the canary rollout, use the following command to process the kustomization:

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
oc apply -k ./canary/base -n user%USERNUM%-prod
----

Once you have run the command we can confirm that the rollout has deployed successfully. Use the following command to ensure
that the pods are up and running:

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
oc get pods -l app=rollouts-demo -n user%USERNUM%-prod
----

The console should return something similar to:

[TODO]
Update list below for eight replicas

[.console-output]
[source,bash,subs="attributes+,+macros"]
----
NAME                             READY   STATUS    RESTARTS   AGE
rollouts-demo-66d84bcd76-pxtnc   1/1     Running   0          64s
rollouts-demo-66d84bcd76-q49wt   1/1     Running   0          64s
----

Retrieve the stable route URL using the command below and copy to a browser tab:

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
oc get route -n user%USERNUM%-prod stable -o jsonpath='{"https://"}{.spec.host}{"\n"}'
----

The application is running with blue squares for the current version of the application:

image:rollouts-demo-app-blue.png
